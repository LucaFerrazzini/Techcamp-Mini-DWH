trigger:
- sql-syntax-check


# Azure SQL Database deployment
# Deploy an Azure SQL Database using DACPAC or run scripts using SQLCMD
stages:
- stage: Validate
  jobs: 
  - job: Validate
    pool:
      vmImage: windows-latest
    variables:
      server: $(server)
      user: $(sqlUserUsername)
      password: $(sqlUserPassword)
      sqlFile: $(Build.SourcesDirectory)/sql/VALIDATION_SCRIPT.sql 
    steps:
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          echo Creating Deployment File
          cd sql
          Get-Content 10_SOURCE.sql, 20_ODS.sql, 30_CORE.sql, 40_MART.sql, 99_PROCEDURES.sql | Set-Content DEPLOYMENT_SCRIPT.sql
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          echo Creating Validation File
          cd sql
          ((Get-Content DEPLOYMENT_SCRIPT.sql) -replace "'","''") | Set-Content DEPLOYMENT_SCRIPT_CLEAN.sql
          Get-Content 00_VALIDATE.sql, DEPLOYMENT_SCRIPT_CLEAN.sql | Set-Content VALIDATION_SCRIPT.sql
          Add-Content VALIDATION_SCRIPT.sql -Value "'"

          Invoke-Sqlcmd -ServerInstance $SERVER -Database "mini-dwh-db" -Username $USER -Password $PASSWORD  -Inputfile $SQLFILE  -ConnectionTimeout 120 -Verbose
    - task: SqlAzureDacpacDeployment@1
      inputs:
        azureSubscription: $(subscription)
        serverName: mini-dwh-server.database.windows.net # Required when authenticationType == Server || AuthenticationType == AadAuthenticationPassword || AuthenticationType == AadAuthenticationIntegrated || AuthenticationType == servicePrincipal
        databaseName: mini-dwh-db # Required when authenticationType == Server || AuthenticationType == AadAuthenticationPassword || AuthenticationType == AadAuthenticationIntegrated || AuthenticationType == servicePrincipal
        sqlUsername: $(sqlUserUsername) # Required when authenticationType == Server
        sqlPassword: $(sqlUserPassword) # Required when authenticationType == Server
        deployType: 'sqlTask' # Options: dacpacTask, sqlTask, inlineSqlTask
        sqlFile: $(Build.SourcesDirectory)/sql/VALIDATION_SCRIPT.sql # Required when deployType == SqlTask
        AdditionalArguments: '-Verbose'
- stage: Deploy
  jobs:
  - job: Deploy
    pool:
      vmImage: windows-latest
    steps:
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          echo Creating Deployment File
          cd sql
          Get-Content 10_SOURCE.sql, 20_ODS.sql, 30_CORE.sql, 40_MART.sql, 99_PROCEDURES.sql | Set-Content DEPLOYMENT_SCRIPT.sql
    - task: SqlAzureDacpacDeployment@1
      inputs:
        azureSubscription: $(subscription)
        serverName: mini-dwh-server.database.windows.net # Required when authenticationType == Server || AuthenticationType == AadAuthenticationPassword || AuthenticationType == AadAuthenticationIntegrated || AuthenticationType == servicePrincipal
        databaseName: mini-dwh-db # Required when authenticationType == Server || AuthenticationType == AadAuthenticationPassword || AuthenticationType == AadAuthenticationIntegrated || AuthenticationType == servicePrincipal
        sqlUsername: $(sqlUserUsername) # Required when authenticationType == Server
        sqlPassword: $(sqlUserPassword) # Required when authenticationType == Server
        deployType: 'sqlTask' # Options: dacpacTask, sqlTask, inlineSqlTask
        sqlFile: $(Build.SourcesDirectory)/sql/DEPLOYMENT_SCRIPT.sql # Required when deployType == SqlTask

